X_Y_Z_1_Model=[-1.81625293554116          1.63168064407459         -5.43405101875695
           2.5119197790656          1.48882208335383           -5.003880190498
         -8.28729027841132          13.7186045550761         -21.8611611240142
          1.98606253329127           4.4720593856161         -7.64260757571054
          -8.4487656155329          9.01039485315098         -17.4314022141723
         -8.55727701569168          6.90687193272371         -15.1501106779234
         -13.4232849232753          14.3322563197882          -22.857093186285
          4.24056400354015          4.32502474727747          -7.3258580567244
         -9.05450856919116          5.56418015567891         -14.0933025190243
          -8.5252141910564          3.65303134255051         -12.3358142146339
          2.89152596467405          4.67276050168933         -7.68464896986657
         -9.38399899762101           10.781565577152         -19.6588436238488
         0.334559197394463          4.33138836998591         -7.16282244209153
          1.05784082830683          3.04603479930678         -6.29967771880804
         -5.94127827579149          3.62728475675181         -11.5942140183782
         -8.16186210535462          3.39984085738726         -12.0864502004868
       -0.0802043905258641          4.40871508209939         -6.96965333173211
          -10.589946227229          13.7810500192426         -22.5930755181498
         -1.34838508327624          2.06654365218216         -5.87817286443624
         -5.97412130358556          4.75698420046002         -12.2952863307748
         -5.67490060258872         0.195030859198849         -8.79652732745298
         -1.43353808769566          2.96047940399129         -6.48927729781882
        -0.266045893372463          2.59802113964942         -5.86685258839218
         -8.93144043795377          12.6451503796413         -21.5019609020555
          2.72568229777091          4.66967432436332         -7.64704688966683
         -9.30976914831342          6.72245267365821         -14.9956507442782
         -5.96133866726736            3.818888300796         -11.7550438654429
          4.06450214160565          4.15778449007813         -7.57185303016903
         -10.3620652428505           8.8063479320557         -17.2332475281738
        -0.258884503488583          3.16735322260547         -6.39566043161532
         0.942702454512988          1.93679785313465         -5.61171001911578
          1.52717968516361          3.44069454226389         -6.72140508483648
          -1.5958947382032          5.02731802565657          -8.5584292528814
         -1.93025184007204          4.30258254618405         -7.67463454876643
         -8.31197091696775          5.05904138374503         -13.6749529889226
         -1.93102475565732          4.49802759227272         -7.94928598084366
         -1.25125941130191          4.66713131537623         -8.05770641228067
          1.84648384419001          3.41493178088604          -6.6927688150728
          1.44499919887397          3.23736794025124         -6.68155395631137
         -9.63682657102942           5.3639853391514         -14.0935699555649
        -0.477171538235116         0.983811578011326         -4.45151950509325
         -1.98754049904224          4.63011313104632         -7.54034750852265
          1.94469556041869          3.21707693200721         -6.57058066559767
         -5.37758896716908          4.33230905815059         -11.6812788521206
         -9.39359890012623          12.8832245247801         -21.0064844473317
          2.86779012380022          4.47218767724139         -7.53326646559193
         -1.83880699134309          2.99825966398628         -6.56547151899149
        -0.737291576646119             2.81771388958         -5.86566556080841
         -5.64005207630723         0.662892916689934         -9.30919960121971
         -8.98260228550233          7.54019377859507         -15.0825009252509
        -0.286687770869187          1.75076229166056         -4.98633253101662
         0.782059219521212          3.95654800021751         -7.16663231524889
       -0.0999130558762249          1.68449898932295         -4.75739649447633
         -1.89503040591158          4.34796160259728          -7.8972654058972
         -1.89483320481908          4.62518133552526         -8.21767109463199
         -5.38193831211348          6.35194331236036         -13.4993161851751
          1.90190961986017          4.93375056294792         -7.70087839751824
         -6.06685101615711          3.05796316676277         -10.9800044781489
         -1.88671822951514          3.05543403655382         -6.56746709340595
         -7.38982117948164          6.68692428112964         -14.9597684120537
          2.83782645633326          4.22364995832967         -7.26414511492136
        -0.249332115123602           1.7014592224333         -4.82803372653743
          2.26444928262784          2.84278808136346          -5.9699717077028
         -8.44863438973821          12.0027119882654         -20.2588544468441
       -0.0750937605497032          4.46246787564912         -7.06357547832496
          1.49326875806682           3.3088684954681         -6.76606000746343
          6.19095363043399          7.00088734224458         -11.1003524676025
         -8.26969986461657          3.32799507650131         -11.9887222429097
      -0.00109027368597661          3.00327266170358         -6.02601192091379
           -6.383076073824          2.48191033897924         -10.6070598786058
         -6.38615090364595          2.28036379421363           -10.57225021092
         -9.57879770917291          11.1357024974323         -19.5765515550477
          -16.051507304703          12.9031837268697         -21.9687010618588
         -9.36772387426554          10.8083265802026         -19.4512359927008
        -0.178898054438795          3.66557255539371          -6.5018746953291
         -10.5675494064559          10.9679727326381         -19.6175266906646
         -5.40186122143573          4.28016743189607         -11.5953182676121
         -9.93850980888702          9.91870407387197         -18.5112405871636
         -1.89680844726788          4.65466024794749         -8.21388835469996
         -12.3320440630545          12.7378722985495         -20.9486055546876
         -14.4051400369787          12.6894487776917          -21.787112914925
         -8.94295322226657          12.3128884528768         -20.3439857806325
         -11.0584088328122          11.1003109034943         -19.7666956290211
        -0.152660862166241          4.26057472159665         -7.01684516015306
         -6.65835062881812          3.97490102041934          -11.767961546027
         -8.48870902315596          13.5218580636305         -22.0648659073951
         -10.4526350034304           5.7302908824045         -14.2563815104583
         -9.08462009033708           9.8450523752317         -18.4642937531608
         -6.80353757257007          3.73790375918521         -11.5960244093555
         -12.3529594959711          11.7967896275347         -20.6619946042311
         -5.18948923067243          4.45137570476305          -11.625858106223
          -13.840485410802          14.9501544362335          -23.731136366333
         -6.79874829796507          3.51059255429128         -11.3681859709588
          -2.3417040944992          2.88863483208247         -7.02583730460388
         -6.44745975276713          3.11762550193742         -11.0203513813856
          -11.302210681058          14.0593041281696         -22.7778158977535
         -12.0972380111032          10.6834010799455         -19.5636779193799
         -1.47808909226523          4.88339254677165         -8.25721737429214
         -9.64387107948871          6.90528166498356         -14.7938145215065
         -6.20701198115317           2.0381102857872         -10.3885906855693
           1.6830143414637          3.30769242636323         -6.05399197084308
          2.47914835569487          2.96030407828696         -6.07085545432126
         -12.2643250437068          13.2774222476396          -21.233421414885
        -0.237981763556859          3.12126866803878         -6.43674287355086
        -0.299804802843718          1.62545881790562         -4.80876062431871
          1.84064959420158          3.27164072244805         -6.65244527212712
         -5.67133192011667          4.92005379407199         -11.7538690189163
         -2.32714018512743           2.0101801683412         -5.55314774325272
         -6.54823359992682            3.664390203038         -11.5846798256484
          2.78539156880549          4.67673295482776         -7.68526360203169
         -5.17840883689421          5.05910020130425         -12.2327098867257
          1.63341365081101          3.89994576138917         -6.91115949889559
         -9.41663621619617          6.10381989418583         -14.3169860339057
         -1.69726346968661          1.26316678587484         -5.20377902626367
         -9.23888791473599          3.85586338740762         -12.4152578428103
         0.783794116230984          3.91589181158929         -7.21632408035419
         -2.81733322538292          -1.5922109907254         -5.25669352378148
         -6.27534781076641          1.72723507416762         -10.0593420295668
         0.513204878531469          0.30482521598868         -3.38782361462021
         0.801728455366723         0.305422837790053         -3.42901381335772
         -1.69427539762816        -0.344473314807864          -3.8570133043138
         -0.67001704314831          2.01013907017094         -5.27992263812316
        -0.644326583678917         0.562904711788137         -4.47314935851352
         -0.69819191036327         0.544935861482834         -4.43775543171595
         0.603303012335407         0.146396208729178         -3.13300722681852
          1.77265671444659         0.107350029779486         -3.66655385865355
         -0.11448807513613        -0.323369425149958         -3.29247085949218
          2.21612665447327          2.13542013930446         -4.90509909406042
           1.0843172431164        0.0796186851887402         -3.20677843635783
        -0.999731047557045         0.386805131242789          -3.7592742872789
        -0.138946933017968        -0.185269143718831         -3.33851952725427
          1.20266872183744       0.00497979576768937          -2.9840083166149
       -0.0564418662624033        -0.315332177895194         -3.29888012232696
          1.23595655097693       -0.0241733954427965         -2.99849566884015
         -6.40908204567221          1.59444008315978         -9.84989411595147
         0.935510384137304       -0.0320155279093408         -2.93253433531018
         0.560976142289768         0.309252734400693         -3.42319275503048];
X_Y_Z_2_Object=[9.01512768246787         -6.02358840106565          24.6496801040365
         -12.4144598538841         -5.32218493773872          22.6202965000947
          41.3486911905175         -66.5098490819384          106.803150947468
         -9.85039953115688         -20.2032075116429           35.811681868099
          43.0107000103354         -43.8396136150041          86.4094576191477
          44.0454195476267         -33.4883619081322          75.6261727434835
          66.3617215276328          -68.975479855859          110.748788877605
         -20.8979238242356         -19.3077985014276          33.9565656960369
          45.5727579402896          -25.993443965308          68.6371959249925
          42.5523394259235         -16.2260227043228          59.2982698164806
         -14.0749155259942         -20.7789150552698          35.3110764451321
          44.8393408235558         -49.6409697057011          91.7524411580031
         -1.66734745699667         -19.9089508229428          34.1748144621667
          -5.1410714174109         -12.8934628065366          28.6660221456515
          30.0839864018496         -16.3015737342372          56.3827052860498
          41.1977965168047          -15.128683250713           58.706597392887
         0.361561468745532         -16.6747133621549          27.1002331853666
          51.3079970253821         -64.8950281388286          107.256726522855
          6.72440701022875         -8.19542669848563          26.9284423514251
          30.1825166189335          -21.967265450513          59.7967692830105
          27.7448024283669          1.02560739328139          40.7753458374412
          7.16110762787994         -12.6540125475911          30.0278430060156
          1.45037444879722         -11.5381187415767          28.6750135166588
          41.5950124873145         -57.0700256602387          98.0139134512394
         -13.5647426668821         -21.2394468661157          35.9192669353582
          47.2283271203506         -32.0724636952375          73.7569350217321
          29.7451295597857         -17.0242479214515          56.3621157285119
         -19.7645596526797         -18.2445295779407          34.7086274271171
          51.4662849667782         -41.7662103346706          83.3271161884297
          1.27641229776183         -13.2175373352975          28.4834203197891
         -4.59896868523074         -7.49279045502521           25.446362454727
         -7.45193651918586         -14.8499814008501          30.7754254325544
          7.78361300380861         -22.4363426986408          39.4044777825369
          9.61175453957962         -19.3215635202012          35.8651614745594
          41.4088182997026         -23.2040649666471          65.8502761511918
          9.47972479422847         -20.0017710771005          36.7037660049867
          6.15358108967593         -20.8336826737449          37.2330611204014
         -9.07416001015589         -14.8116009295192          30.8270978820325
           -7.053693188126         -13.8625900312317          30.6050073846027
          47.7880662953372         -24.6088742419541          67.6286202484138
           2.4080304376124         -2.83518433457369          19.8365936470658
          9.77562016561904         -20.6889109151701          34.7730513981524
         -9.50276612269025         -13.7528732352687           30.050426482298
          26.6949596410848         -19.4754925688038          55.7014896495828
          46.1981699065087         -61.4609971350741          101.068831044167
         -14.0885805915908         -19.9842428686414          34.8961321303702
          9.29808921062625         -13.0281111682517          30.8164713408941
          3.81361603028605         -12.2980854588734          27.7363754928851
          27.6681909930317         -1.25426693988144          43.4244010820736
          44.8469297161507         -35.6649988418844          73.0212516007901
          1.50407310921185         -6.78855003667295          23.1172847137754
         -4.00209066705379          -18.292649797916          34.7089977526788
         0.585936538802147         -6.85844573914449           23.224280119327
           9.5236768006275         -19.7273448149703           37.309952321627
          9.34961759224457         -20.7349356049191          38.2099653103298
          27.6645009349946         -30.5672164263832          67.0193870612201
         -9.47491088196618         -22.5989093109532           36.258298991796
          30.3539665606149         -13.2630449397174          52.6425705178177
          9.52412158200979         -13.2939595500605          30.7777842868426
           37.750337899347         -32.1080130063137          74.0785700976654
         -13.9984802462984         -18.8380031467861          33.7129052271676
          1.32231160412866         -6.61349932741466          22.4501897937578
         -11.1621634132944         -12.0131180377437          27.3314406427953
          43.4719688974945         -59.7513186140836          101.891665752618
         0.400231510230993         -19.8174674049902          32.3455082640364
         -7.22569601555014         -14.0791588946158          30.7421272218579
         -30.5894409787291         -32.5973339658547          52.6655221445356
          41.7819698233699         -14.7791002899218          58.2700414939903
        0.0238010554242251         -7.13222223988847          14.7762639107626
          32.5424495633343         -10.5790876474795          51.7460544688047
          32.6141260255417         -9.56205498697624          51.6574548934847
          45.9027484290823         -51.4731745785369           91.624976662588
          79.0146261107123         -61.6429677541602          105.899708930604
          46.3374049174682         -51.5082347287296          93.9558027030697
         0.842202317263181         -14.7448683984715            27.37868789966
          53.0981922435919         -53.1403167512491          96.2779932943804
          27.0618165087856         -19.3922569838073          55.7833261283329
          48.4119937358192         -46.3744179012855          87.9463016518108
          9.39913045354373         -20.9688877879825          38.3540629257682
          60.9628271958048         -61.0566353802533          101.305208359885
          69.0643667347295         -59.0045512352928          102.272076016478
          45.0085608347034         -60.0233782365823            100.0919791856
          52.4387096854157         -50.7815047836286           91.569792046325
         0.744492889563932         -17.9677912490802          30.6499381910533
          33.6668063354347         -18.0468320246039          57.1876578442801
          41.2270150707897         -63.7894295512146          104.950676400078
          52.3228828490994          -26.692379015654          69.0847460352724
          45.7505167765536         -47.5869129345766          90.6846143904412
          34.0582768006211          -16.678976780066          55.7593383893158
          59.8873159812124         -55.3160175014875          97.9594054857055
          26.6598770720869         -20.7705452567277          57.3579130510053
          67.5494679391807         -71.1034387917795          113.599491912454
          33.8591600884338         -15.4534302507336          54.3387128767045
          11.7246536446321         -12.3680993431761          32.8385944798006
          32.2564896823512         -13.5604970768449          52.8453635830525
          54.9647059247113         -66.5090288656187          108.558563669602
           59.874307257891         -50.9395897574784          94.5719455084516
          7.38440800996524         -22.2583858608279          38.8496503804098
          48.6659790027468         -32.8328467901697          72.3524349303849
          31.3335562664121         -8.22742651931341          50.1335121188902
         -9.39158581597939         -16.2560801161131          31.4401823360459
          -12.095534895717          -12.457602977791          27.5358020876949
          64.4229165446833          -67.725280695069          109.142734820901
          1.21156270912835         -13.3475776496064          29.5344588483322
          1.53417983948332         -6.04327435693559          21.6892753927852
         -9.15715416033345          -14.266869899402           31.009264621761
          29.2703591485479         -23.3384607987129          58.2911397019604
          11.6517063494347         -7.97422936291355          25.4865911092231
          32.7680304138765         -16.2968136487398          55.6794772285714
          -13.664643589551         -20.9690724341156          35.5941264840804
          25.9845201759918         -23.3520886362377          59.0675667700753
         -8.13619918444145         -17.4509116792488           32.345860886502
           47.494833688875         -28.7681911967173          69.9104621490166
          8.46218066682274         -4.22123662907709          23.6074243206534
           46.232141218975         -17.2833532865293          59.8505992374277
         -3.86781929616356         -17.4447568747635          33.7185429568117
          14.0467580058987           9.9619213297694          23.9193157963882
          31.6195624548729         -6.67081935145387           48.384086355299
         -2.54921693115161         0.562756822555988          14.9229273733412
         -3.95941149548098         0.556557182187808          14.9374581171337
          8.42130794495004           3.7528752760045          16.8733368222394
           3.3188251457896         -7.81797704618316          23.6483548473377
          3.18344528403172        -0.729160706215358          19.6175495547699
          3.49612413407998        -0.650295885794433          19.7301346643492
         -3.00725950564294          1.37031149111012          13.6431222539249
         -8.81884786785948           1.5485884998908          16.1347086694063
         0.586425631084062          3.49599279770026          13.3791939585215
           -10.89599892173         -8.49250977259146          22.0183608169763
         -5.08940621435143          1.60722900805163          13.1006281800654
          4.98588611727694         0.136936274572237          16.3806951307428
         0.720004492468568          2.90080447204371          13.9692973476909
         -5.96184834548134          2.06438143290038          12.7105031073558
         0.298598914381565           3.1996527639377           12.751381861384
         -6.09437949475096          2.19807122343167          12.7126114509198
          31.8332362250547          -5.9085000340401          46.6571027521023
          -4.6554122091335          2.26007422580879          12.5326021171911
         -2.75610288727404         0.539466731417186          14.9119824847979]
XYZ_O_M=[0.01
          0.41983722300518
        -0.442192854036357]
X_Y_Z_1_Model=X_Y_Z_1_Model'
X_Y_Z_2_Object=X_Y_Z_2_Object'
XYZ_O_B=[0;0;0];
n=size(X_Y_Z_1_Model,2);




phi=-0.404786806;W=0.5055696;kapa=0.202279;landa=4.94252;Cy=2.24061;Cz=-2.0696523;Cx=0.33016;
R_phi = [cos(phi) 0 -sin(phi) ; 0 1 0 ; sin(phi) 0 cos(phi)];
R_omega = [1 0 0 ; 0 cos(W) sin(W) ; 0 -sin(W) cos(W)];
R = R_phi*R_omega;
R_kapa = [cos(kapa) sin(kapa) 0 ; -sin(kapa) cos(kapa) 0 ; 0 0 1];
MAT00=[[R;0 0 0],[0 ;0 ;Cz ;1]]*[[landa*R_kapa;0 0 0],[Cx ;Cy ;0 ;1]];
MAT00=[[landa*R*R_kapa;0 0 0],[Cx ;Cy ;Cz ;1]];
X_Y_Z_2_Object=MAT00*[X_Y_Z_1_Model;ones(1,n)];
X_Y_Z_2_Object=X_Y_Z_2_Object(1:3,:)+0.4*(rand(3,n)-0.5);
% 

% [EEQ,ERMSE,Eerror]=Absolute_Orientation_3dConformal(X_Y_Z_1_Model,X_Y_Z_2_Object)
% X_Y_Z_2_Object0=EEQ*[X_Y_Z_1_Model;ones(1,n)]-[X_Y_Z_2_Object;ones(1,n)];
% X_Y_Z_2_Object00=(EEQ*[X_Y_Z_1_Model;ones(1,n)]-[X_Y_Z_2_Object;ones(1,n)])
% Landa0=sqrt(sum(EEQ(1:3,1).^2))
% phi0=asin(EEQ(3,1)/Landa0)
% omega0=asin(-EEQ(3,2)*sec(phi0)/Landa0)
% kapa0=asin(-EEQ(2,1)*sec(phi0)/Landa0)
% Tx0=EEQ(1,4)
% Ty0=EEQ(2,4)
% Tz0=EEQ(3,4)



% syms kapa phi omega Tx Ty Tz Landa
% Rk=[cos(kapa) sin(kapa) 0; -sin(kapa) cos(kapa) 0; 0 0 1];
% Rph=[cos(phi) 0 -sin(phi); 0 1 0; sin(phi) 0 cos(phi)];
% Romg=[1 0 0; 0 cos(omega) sin(omega); 0 -sin(omega) cos(omega)];
% EQ=[Landa*Rk*Rph*Romg,[Tx;Ty;Tz];0 0 0 1];






%=====================================
% X_Y_Z_2_Object=(Landa*Rk*Rph*Ro*X_Y_Z_1_Model)+T;
%=====================================
X_Y_Z_1_Model_0=X_Y_Z_1_Model;
XYZ_O_M_0=XYZ_O_M;
EQ=eye(4);
n=size(X_Y_Z_1_Model,2);
%=====================================
MAT=5*eye(4);
for iii=1:6
% while norm(MAT-eye(4))>1e-2
% h=1;
% while h~=4
%     h=h+1;
G_Model=X_Y_Z_1_Model(1:2,:)-mean(X_Y_Z_1_Model(1:2,:)')'*ones(1,n);
G_Object=X_Y_Z_2_Object(1:2,:)-mean(X_Y_Z_2_Object(1:2,:)')'*ones(1,n);
% % G_Model=X_Y_Z_1_Model(1:2,:);
% % G_Object=X_Y_Z_2_Object(1:2,:);
A=[];L=[];
A(1:2:2*n,:)=[ G_Model(1,:)' G_Model(2,:)' ,ones(n,1) ,zeros(n,1)];
A(2:2:2*n,:)=[G_Model(2,:)' -G_Model(1,:)' ,zeros(n,1) ,ones(n,1)];
L(1:2:2*n,:)=G_Object(1,:)';
L(2:2:2*n,:)=G_Object(2,:)';
N=A'*A;u=A'*L;
a=u(1)/N(1,1);
b=u(2)/N(2,2);
landa=sqrt(a^2+b^2);
kapa=atan2(b,a);
Cx= mean(X_Y_Z_2_Object(1,:)-a.*X_Y_Z_1_Model(1,:)-b.*X_Y_Z_1_Model(2,:));
Cy= mean(X_Y_Z_2_Object(2,:)-a.*X_Y_Z_1_Model(2,:)+b.*X_Y_Z_1_Model(1,:));
% % unknown_M4=inv(N)*u;
% % a=unknown_M4(1);b=unknown_M4(2);Cx=unknown_M4(3);Cy=unknown_M4(4); landa=sqrt(a^2+b^2);
% %  kapa=atan(b/a);


% A=[];L=[];
% A(1:2:2*n,:)=[ X_Y_Z_1_Model(1,:)' X_Y_Z_1_Model(2,:)' ,ones(n,1) ,zeros(n,1)];
% A(2:2:2*n,:)=[X_Y_Z_1_Model(2,:)' -X_Y_Z_1_Model(1,:)' ,zeros(n,1) ,ones(n,1)];
% L(1:2:2*n,:)=X_Y_Z_2_Object(1,:)';
% L(2:2:2*n,:)=X_Y_Z_2_Object(2,:)';
% N=A'*A;u=A'*L;
% unknown_M4=inv(N)*u;













R_kapa = [cos(kapa) sin(kapa) 0 ; -sin(kapa) cos(kapa) 0 ; 0 0 1];
%=====================================
X_Y_Z_second_Model=[a b 0;-b a 0;0 0 landa]*X_Y_Z_1_Model+[Cx;Cy;0]*ones(1,n);
X_Y_Z_second_Model=[[landa*R_kapa;0 0 0],[Cx ;Cy ;0 ;1]]*[X_Y_Z_1_Model;ones(1,n)];
X_Y_Z_second_Model=X_Y_Z_second_Model(1:3,:);
XYZ_O_M=[a b 0;-b a 0;0 0 landa]*XYZ_O_M+[Cx;Cy;0];
%=====================================W_Phi_Cz
A=[];
L=[];
A=[-X_Y_Z_second_Model(2,:)' X_Y_Z_second_Model(1,:)' ,ones(n,1)];
L=[X_Y_Z_2_Object(3,:)-X_Y_Z_second_Model(3,:)]';
% L=[L;XYZ_O_B-XYZ_O_M];
% A=[A;0 -XYZ_O_M(3) 0;XYZ_O_M(3) 0 0;-XYZ_O_M(2) XYZ_O_M(1) 1];
Unknown_M3=inv(A'*A)*A'*L;
W=Unknown_M3(1);
phi=Unknown_M3(2);
Cz=Unknown_M3(3);


R_kapa = [cos(kapa) sin(kapa) 0 ; -sin(kapa) cos(kapa) 0 ; 0 0 1];
R_phi = [cos(phi) 0 -sin(phi) ; 0 1 0 ; sin(phi) 0 cos(phi)];
R_omega = [1 0 0 ; 0 cos(W) sin(W) ; 0 -sin(W) cos(W)];
R = R_phi*R_omega;
%% 
% syms Cz phi W
% R_phi = [cos(phi) 0 -sin(phi) ; 0 1 0 ; sin(phi) 0 cos(phi)];
% R_omega = [1 0 0 ; 0 cos(W) sin(W) ; 0 -sin(W) cos(W)];
% R = R_phi*R_omega;
% F=X_Y_Z_2_Object(3,:)-R(3,:)*X_Y_Z_second_Model-Cz*ones(1,n);
% F=reshape(F,[],1);
% unknown = [W phi Cz];
% unknown0 = [0 0 1];
% A0 = jacobian(F,unknown);
% dx=1;
% while (norm(dx)> 1e-10)
%     A = eval(subs(A0,unknown,unknown0));
%     df = eval(subs(F,unknown,unknown0));
%     dx =-inv(A'*A)*A'*df;
%     unknown0 = unknown0 + dx';
%     norm(dx)
% end
% W=unknown0(1);phi=unknown0(2);Cz=unknown0(3);
% R_phi = [cos(phi) 0 -sin(phi) ; 0 1 0 ; sin(phi) 0 cos(phi)];
% R_omega = [1 0 0 ; 0 cos(W) sin(W) ; 0 -sin(W) cos(W)];
% R = R_phi*R_omega;
% R_kapa = [cos(kapa) sin(kapa) 0 ; -sin(kapa) cos(kapa) 0 ; 0 0 1];
%==========================Apply M3==========
% X_Y_Z_1_Model=[1 0 phi;0 1 -W;-phi W 1]*X_Y_Z_second_Model+[0;0;Cz]*ones(1,n);
% XYZ_O_M=[1 0 phi;0 1 -W;-phi W 1]*XYZ_O_M+[0;0;Cz];
% MAT=[1 0 phi 0;0 1 -W 0;-phi W 1 Cz;0 0 0 1]*[a b 0 Cx;-b a 0 Cy;0 0 landa 0;0 0 0 1]
% EQ=MAT*EQ;
X_Y_Z_1_Model=R*X_Y_Z_second_Model+[0;0;Cz]*ones(1,n);
X_Y_Z_1_Model=[[R;0 0 0],[0 ;0 ;Cz ;1]]*[X_Y_Z_second_Model;ones(1,n)];
X_Y_Z_1_Model=X_Y_Z_1_Model(1:3,:);
XYZ_O_M=R*XYZ_O_M+[0;0;Cz];
MAT=[[R;0 0 0],[0 ;0 ;Cz ;1]]*[[landa*R_kapa;0 0 0],[Cx ;Cy ;0 ;1]];
EQ=MAT*EQ;
end
phi
Cz
W
kapa
Cx
Cy
landa
% MAT00-EQ
% EQ-EEQ
% MAT00-EEQ
%RMSE
error=(EQ*[X_Y_Z_1_Model_0;ones(1,n)]-[X_Y_Z_2_Object;ones(1,n)]).^2;
% error=sqrt(sum(error(1:3,:)))'
 RMSE=sqrt(sum(sum((EQ*[X_Y_Z_1_Model_0;ones(1,n)]-[X_Y_Z_2_Object;ones(1,n)]).^2)))/(3*n);
%  error=X_Y_Z_1_Model-X_Y_Z_2_Object

% X_Y_Z_1_Model=EQ*[X_Y_Z_1_Model_0;ones(1,n)];
% X_Y_Z_1_Model=X_Y_Z_1_Model(1:3,:);

%% 

% A=[X_Y_Z_1_Model_0',ones(n,1),zeros(n,8);
% zeros(n,4),X_Y_Z_1_Model_0',ones(n,1),zeros(n,4);
% zeros(n,8),X_Y_Z_1_Model_0',ones(n,1)];
% L=[X_Y_Z_2_Object(1,:)';X_Y_Z_2_Object(2,:)';X_Y_Z_2_Object(3,:)'];
% x=inv(A'*A)*A'*L;
% abs_Matrix=[reshape(x,4,3)';0 0 0 1];
% error=(abs_Matrix*[X_Y_Z_1_Model_0;ones(1,n)]-[X_Y_Z_2_Object;ones(1,n)]).^2;
% error=sqrt(sum(error(1:3,:)))';
%  RMSE=sqrt(sum(sum((abs_Matrix*[X_Y_Z_1_Model_0;ones(1,n)]-[X_Y_Z_2_Object;ones(1,n)]).^2)))/(3*n);
% %  error=X_Y_Z_1_Model-X_Y_Z_2_Object
% H=abs_Matrix(1:3,1:3)
% H*H'




























% EQ =
% 
%          -4.94245131961457        0.0113989412984637        0.0235956190405905         0.330169520173585
%        -0.0112672176106298         -4.94243098466969        0.0275816505088085          2.24061657350041
%        -0.0236588019128022        -0.027527473090524         -4.94238750354298         -2.06965230461702
%                          0                         0                         0                         1
% 
% 
% RMSE =
% 
%         0.0619537597280816
% 
% 
% error =
% 
%          0.237905976382137
%          0.239098174313296
%           1.17590721984649
%          0.380279166278249
%           2.91611704863152
%            3.5181755951104
%          0.138780750464576
%          0.169506379297066
%           1.32669605667578
%          0.479719323826601
%          0.514467520283304
%           4.04871897556153
%           1.13307384145094
%           0.33553428027066
%           1.32138957490774
%           1.26101736594093
%           6.00503256396115
%           2.83573559779853
%          0.174744890876711
%           1.29595178169574
%          0.874980195879892
%          0.182819607548017
%           1.97586844223571
%            7.5150449036159
%          0.512776169219486
%           2.18413726760804
%          0.375183462741955
%          0.553112331675499
%          0.340706775384745
%           1.06603616239992
%          0.214705733123308
%          0.293959095271755
%          0.871340951529167
%          0.182572945772218
%          0.411575582639943
%          0.540581279499899
%          0.518823838609985
%          0.168031490813949
%          0.273572914117364
%          0.121575048098219
%          0.224343038162085
%          0.449392883419447
%          0.266355727331276
%         0.0532839684726931
%          0.739964683783005
%          0.183694900109398
%          0.557253213222716
%          0.990180719281095
%          0.710318011790666
%          0.742763294552461
%          0.648553566329938
%           1.70906883399995
%           1.94057472370992
%          0.509732478082546
%          0.337224999412789
%           2.83218806472227
%          0.572446892993906
%          0.491755255299061
%          0.507947921781671
%           2.69200445272059
%          0.192717424309743
%          0.779963984470285
%           0.19428709889654
%           4.85424987537651
%          0.459718317804615
%          0.558197555364784
%          0.289381821008451
%           1.32531755165926
%           14.0374122996838
%           1.61519945369478
%           1.70642290906151
%           3.74495393432581
%          0.759617762401557
%          0.115597954281643
%           2.91331739031947
%           1.84684284345109
%           0.63275460975234
%           1.79520499233228
%           0.18774236557082
%          0.144892647977985
%           4.37258071694803
%           2.14461354036702
%            5.1063138366796
%             2.131626347426
%           1.29884124271981
%           2.38100039597538
%           0.91685151339459
%           1.92433250979064
%          0.601886488723249
%            2.6331307437808
%           2.29139250693573
%           2.02079303610271
%          0.245450398412374
%          0.269144201341659
%          0.502441211188235
%           2.36629196398535
%           0.10585247252214
%          0.281236188955162
%           1.70563647315738
%          0.959805901188301
%            4.4014751687135
%          0.295763887111907
%           8.37045440664791
%          0.220347258138691
%          0.221211652759482
%          0.449596560748245
%            2.7267919368439
%          0.201950803349001
%          0.564404280551485
%          0.218210175326422
%          0.814767294170084
%          0.530606651206049
%           1.56776768918089
%          0.181993161763118
%          0.700068705416145
%           0.34128889747609
%          0.126370157446881
%          0.820848356970141
%           0.38553137440701
%          0.273711061111292
%          0.273096683219521
%          0.404151846768619
%          0.485697031789007
%          0.244538234112575
%          0.379410127817557
%          0.330790629191426
%          0.902334367251019
%           0.18778217274084
%           0.66588895426513
%          0.265777394810401
%          0.542672700413723
%          0.289499251166363
%           1.59427366716062
%          0.253603807660121
%          0.102077565975831
%          0.323310925961786
%          0.261237439008935